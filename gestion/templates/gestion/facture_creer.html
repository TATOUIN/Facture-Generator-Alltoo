{% extends 'base.html' %}

{% block content %}
  <div class="container mt-4">
    <h2>Créer une facture</h2>

    <form method="get" class="row g-2 align-items-end mb-4">
      <div class="col-sm-4">
        <label for="q" class="form-label">Rechercher un produit</label>
        <input type="text" name="q" id="q" value="{{ search_query }}" class="form-control" placeholder="ex: banane">
      </div>
      <div class="col-sm-4">
        <label for="sort" class="form-label">Trier par</label>
        <select name="sort" id="sort" class="form-select">
          <option value="nom" {% if sort_option == 'nom' %}selected{% endif %}>Nom A→Z</option>
          <option value="-nom" {% if sort_option == '-nom' %}selected{% endif %}>Nom Z→A</option>
          <option value="prix" {% if sort_option == 'prix' %}selected{% endif %}>Prix croissant</option>
          <option value="-prix" {% if sort_option == '-prix' %}selected{% endif %}>Prix décroissant</option>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">Filtrer</button>
      </div>
    </form>

    <form method="post">
      {% csrf_token %}

      <div class="row">
        <div class="col-md-8">
          <ul class="list-group">
            {% for produit in page_obj %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <input type="checkbox" name="produits" value="{{ produit.id }}" class="form-check-input me-2">
                  <strong>{{ produit.nom }}</strong> – {{ produit.prix }} €
                </div>
              </li>
            {% empty %}
              <li class="list-group-item">Aucun produit disponible</li>
            {% endfor %}
          </ul>

          <div class="pagination mt-4">
            {% if page_obj.has_previous %}
              <a href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&sort={{ sort_option }}" class="btn btn-outline-secondary">← Précédent</a>
            {% endif %}

            <span class="mx-3">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&sort={{ sort_option }}" class="btn btn-outline-secondary">Suivant →</a>
            {% endif %}
          </div>
        </div>

        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              Produits sélectionnés
            </div>
            <ul class="list-group list-group-flush" id="selected-products">
              <!-- Rempli dynamiquement en JS -->
            </ul>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-success mt-3">Créer la facture</button>
    </form>
  </div>

  <script>
    const checkboxes = document.querySelectorAll('input[type="checkbox"][name="produits"]');
    const selectedList = document.getElementById('selected-products');

    function updateSelectedList() {
      selectedList.innerHTML = '';
      checkboxes.forEach(cb => {
        if (cb.checked) {
          const label = cb.parentNode.innerText.trim();
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = label;
          selectedList.appendChild(li);
        }
      });
    }

    checkboxes.forEach(cb => cb.addEventListener('change', updateSelectedList));
    updateSelectedList(); // Init
  </script>
{% endblock %}